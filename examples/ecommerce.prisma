generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
  MODERATOR
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
  CRYPTO
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  OVERNIGHT
  PICKUP
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  PROCESSING
  COMPLETED
  DENIED
}

enum NotificationType {
  ORDER_CONFIRMATION
  SHIPPING_UPDATE
  PAYMENT_RECEIVED
  REVIEW_SUBMITTED
  PRICE_DROP
  BACK_IN_STOCK
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  username     String    @unique
  passwordHash String
  firstName    String?
  lastName     String?
  phone        String?
  role         UserRole  @default(CUSTOMER)
  isVerified   Boolean   @default(false)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  wishlist      WishlistItem[]
  cart          CartItem[]
  vendorProfile VendorProfile?
  notifications Notification[]
  sessions      Session[]

  @@index([email])
  @@index([username])
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String   @default("US")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersAsShipping Order[] @relation("ShippingAddress")
  ordersAsBilling  Order[] @relation("BillingAddress")

  @@index([userId])
}

model VendorProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  businessName  String
  description   String?
  logoUrl       String?
  businessEmail String
  businessPhone String
  taxId         String?
  isVerified    Boolean  @default(false)
  rating        Float    @default(0)
  totalSales    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([businessName])
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([slug])
  @@index([parentId])
}

model Product {
  id          String        @id @default(uuid())
  vendorId    String
  categoryId  String
  name        String
  slug        String        @unique
  description String?
  price       Decimal       @db.Decimal(10, 2)
  compareAt   Decimal?      @db.Decimal(10, 2)
  cost        Decimal?      @db.Decimal(10, 2)
  sku         String        @unique
  barcode     String?
  quantity    Int           @default(0)
  status      ProductStatus @default(DRAFT)
  weight      Float?
  dimensions  Json?
  images      String[]
  tags        String[]
  rating      Float         @default(0)
  reviewCount Int           @default(0)
  salesCount  Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  vendor        VendorProfile    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category      Category         @relation(fields: [categoryId], references: [id])
  variants      ProductVariant[]
  orderItems    OrderItem[]
  reviews       Review[]
  wishlistItems WishlistItem[]
  cartItems     CartItem[]

  @@index([slug])
  @@index([vendorId])
  @@index([categoryId])
  @@index([sku])
  @@index([status])
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  name      String
  sku       String   @unique
  price     Decimal  @db.Decimal(10, 2)
  quantity  Int      @default(0)
  options   Json
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

model CartItem {
  id        String   @id @default(uuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model WishlistItem {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model Order {
  id                String         @id @default(uuid())
  orderNumber       String         @unique
  userId            String
  status            OrderStatus    @default(PENDING)
  subtotal          Decimal        @db.Decimal(10, 2)
  tax               Decimal        @db.Decimal(10, 2)
  shippingCost      Decimal        @db.Decimal(10, 2)
  total             Decimal        @db.Decimal(10, 2)
  currency          String         @default("USD")
  shippingMethod    ShippingMethod @default(STANDARD)
  shippingAddressId String
  billingAddressId  String
  trackingNumber    String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  cancelledAt       DateTime?
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  user            User        @relation(fields: [userId], references: [id])
  shippingAddress Address     @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address     @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]
  payment         Payment?
  refunds         Refund[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  name      String
  imageUrl  String?
  sku       String
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model Payment {
  id                String        @id @default(uuid())
  orderId           String        @unique
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("USD")
  status            PaymentStatus @default(PENDING)
  method            PaymentMethod
  transactionId     String?       @unique
  processorResponse Json?
  failureReason     String?
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds Refund[]

  @@index([orderId])
  @@index([transactionId])
  @@index([status])
}

model Refund {
  id          String       @id @default(uuid())
  orderId     String
  paymentId   String
  amount      Decimal      @db.Decimal(10, 2)
  reason      String
  status      RefundStatus @default(REQUESTED)
  processedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([orderId])
  @@index([paymentId])
}

model Review {
  id               String       @id @default(uuid())
  userId           String
  productId        String
  rating           Int
  title            String
  comment          String?
  images           String[]
  status           ReviewStatus @default(PENDING)
  helpfulCount     Int          @default(0)
  verifiedPurchase Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([rating])
  @@index([status])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}
